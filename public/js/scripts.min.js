let editor_mode=!0,existingClocks=new Map,eventSource=null;function showLoader(e){var t=document.getElementById("loader");t&&(t.style.display=e?"block":"none")}function fetchWithLoader(e,t){return showLoader(!0),fetch(e,t).finally(()=>showLoader(!1))}function removeClock(e){existingClocks.delete(e);e=document.getElementById(e);e&&e.remove()}function setupEventSource(){eventSource&&eventSource.close(),(eventSource=new EventSource("/api/status")).onopen=()=>console.log("EventSource ouvert"),eventSource.onmessage=e=>{try{updateUIFromData(JSON.parse(e.data))}catch(e){console.error("Erreur de parsing:",e)}},eventSource.onerror=()=>{console.warn("Déconnecté, tentative de reconnexion..."),eventSource.close(),setTimeout(setupEventSource,5e3)}}function updateUIFromData(e){var t,n,o,a=document.getElementById("time-container"),s=document.getElementById("stage-message-container"),r=document.getElementById("video-container"),c=document.getElementById("slide-text-container"),d=document.getElementById("presentation-container"),a=(e["timer/system_time"]&&(o=new Date(1e3*e["timer/system_time"]),a.textContent="Heure: "+o.toLocaleTimeString("fr-FR",{hour12:!1})),e["stage/message"]&&(s.textContent=e["stage/message"]?"Message prompteur: "+e["stage/message"]:""),e["timers/current"]||[]),l=new Set(a.map(e=>e.id.name));for([t,n]of existingClocks.entries())l.has(t)||(n.remove(),existingClocks.delete(t));a.forEach(updateOrCreateClock),e["timer/video_countdown"]&&(o=e["timer/video_countdown"],r.innerHTML="0:00:00"!==o?`
            Temps restant vidéo: <span class="${parseInt(o.slice(-2))<11?"blinking":""}">${o}</span>
        `:""),e["status/slide"]?.subtitle&&(c.innerHTML=`<h3>Slide actuelle: ${e["status/slide"].subtitle}</h3>`),e["presentation/active"]&&(d.textContent="titre presentation: "+e["presentation/active"])}function updateOrCreateClock(t){let n=existingClocks.get(t.id.name);var o=document.getElementById("clock-container");if(!n){(n=document.createElement("div")).id=t.id.name,n.classList.add("clock-container");var a=document.createElement("h3");a.innerHTML=t.id.name+': <span class="time"></span>';let e=createControlButton(t,"pause");var s=createControlButton(t,"reset"),r=createControlButton(t,"delete"),c=document.createElement("div");c.classList.add("buttons-container"),c.append(e,s,r),n.append(a,c),o.appendChild(n),existingClocks.set(t.id.name,n)}var e=n.querySelector(".time");switch(e.textContent=t.time,e.className="time",t.state){case"running":e.classList.add("status-running");break;case"overrunning":case"overran":e.classList.add("status-overrun");break;case"stopped":e.classList.add("status-stopped")}let d=n.querySelector(".pause-btn");d&&(s=d.querySelector("i"),"running"===t.state?(s.className="fa-solid fa-stop",d.dataset.state="running"):(s.className="fa-solid fa-play",d.dataset.state="stopped"))}function createControlButton(e,t){let n=document.createElement("button");n.classList.add("button-container");var o=document.createElement("i");switch(t){case"pause":o.classList.add("fa-solid","stopped"===e.state?"fa-play":"fa-stop"),n.appendChild(o),n.classList.add("pause-btn"),n.dataset.uuid=e.id.uuid,n.dataset.state=e.state,n.onclick=()=>toggleTimerState(n);break;case"reset":o.classList.add("fa-solid","fa-rotate"),n.onclick=()=>resetTimer(e.id.uuid),n.appendChild(o);break;case"delete":o.classList.add("fa-solid","fa-trash"),n.onclick=()=>deleteTimer(e.id.uuid,e.id.name),n.appendChild(o)}return n}function toggleTimerState(e){let t=e.querySelector("i");var n=e.dataset.uuid;"stopped"===e.dataset.state?fetchWithLoader("/api/timer/play/"+n,{method:"GET"}).then(()=>{t.className="fa-solid fa-stop",e.dataset.state="running"}):fetchWithLoader("/api/timer/pause/"+n,{method:"GET"}).then(()=>{t.className="fa-solid fa-play",e.dataset.state="stopped"})}function resetTimer(e){fetchWithLoader("/api/timer/reset/"+e,{method:"GET"})}function deleteTimer(e,t){fetchWithLoader("/api/timer/"+e,{method:"DELETE"}).then(e=>{e.ok?removeClock(t):console.error("Erreur lors de la suppression du timer")})}function changeLanguageToEnglish(){document.querySelector("h1").textContent="Client PP7 Hillsong Paris",document.getElementById("user-stage-msg").placeholder="Send prompt message",document.getElementById("send").textContent="Send",document.getElementById("delete").textContent="Delete",document.querySelector(".form-container h2").textContent="Add Clock",document.querySelector('label[for="clock_name"]').textContent="Name",document.querySelector('label[for="hours"]').textContent="Hours:",document.querySelector('label[for="minutes"]').textContent="Minutes:",document.querySelector('label[for="seconds"]').textContent="Seconds:",document.getElementById("submit-button").textContent="Add"}function changeLanguageToFrench(){document.querySelector("h1").textContent="Client PP7 Hillsong Paris",document.getElementById("user-stage-msg").placeholder="Envoyer msg prompteur",document.getElementById("send").textContent="Envoyer",document.getElementById("delete").textContent="Supprimer",document.querySelector(".form-container h2").textContent="Ajouter Clock",document.querySelector('label[for="clock_name"]').textContent="Nom",document.querySelector('label[for="hours"]').textContent="Heures:",document.querySelector('label[for="minutes"]').textContent="Minutes:",document.querySelector('label[for="seconds"]').textContent="Secondes:",document.getElementById("submit-button").textContent="Ajouter"}document.getElementById("stage_msg").addEventListener("submit",function(e){e.preventDefault();var t=document.getElementById("user-stage-msg").value,e=(e.submitter||e.target).id;let n=document.getElementById("result-container");"send"===e?fetchWithLoader("/api/stage/msg",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_input:t})}).then(e=>e.json()).then(e=>{n.innerHTML=e.result?"":"Erreur, message non envoyé"}).catch(e=>console.error("Erreur:",e)):"delete"===e&&fetchWithLoader("/api/stage/msg",{method:"DELETE",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.result?(n.innerHTML="",document.getElementById("user-stage-msg").placeholder="Envoyer msg prompteur"):n.innerHTML="Erreur, message non supprimé"}).catch(e=>console.error("Erreur:",e))}),document.getElementById("submit-button").addEventListener("click",()=>{var e={clock_name:document.getElementById("clock_name").value,hours:document.getElementById("hours").value,minutes:document.getElementById("minutes").value,seconds:document.getElementById("seconds").value};fetchWithLoader("/api/timer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>e.json()).then(e=>console.log("Clock ajoutée:",e)).catch(e=>console.error("Erreur:",e))}),document.getElementById("toggle-dark-mode").addEventListener("click",()=>{document.body.classList.toggle("light-mode");var e=document.getElementById("toggle-dark-mode").querySelector("i");e.classList.toggle("fa-sun"),e.classList.toggle("fa-moon")}),document.getElementById("toggle-language").addEventListener("click",()=>{var e=document.getElementById("toggle-language");("Français"===e.textContent?(e.textContent="English",changeLanguageToEnglish):(e.textContent="Français",changeLanguageToFrench))()}),document.getElementById("toggle-editor-mode").addEventListener("click",()=>{document.getElementById("clock-editor").classList.toggle("invisible"),document.getElementById("clock-container").classList.toggle("invisible-clock"),editor_mode=!editor_mode}),setupEventSource();